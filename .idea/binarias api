form api
import os
import asyncio
import logging
import pandas as pd
import pandas_ta as ta
import ccxt.pro as ccxt
from datetime import datetime
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

# Cargar variables de entorno
load_dotenv()
TOKEN = os.getenv("TELEGRAM_TOKEN")
# Configura los pares que quieres vigilar
SYMBOLS = ['BTC/USDT', 'ETH/USDT', 'SOL/USDT', 'BNB/USDT']
TIMEFRAME = '1h'

# Configuraci√≥n de Logs
logging.basicConfig(
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)

class TradingEngine:
    """Clase encargada de la l√≥gica de mercado y an√°lisis t√©cnico."""
        def __init__(self):
                self.exchange = ccxt.binance({'enableRateLimit': True})

                    async def fetch_data(self, symbol):
                            try:
                                        bars = await self.exchange.fetch_ohlcv(symbol, timeframe=TIMEFRAME, limit=100)
                                                    df = pd.DataFrame(bars, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
                                                                df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')
                                                                            return df
                                                                                    except Exception as e:
                                                                                                logging.error(f"Error obteniendo datos de {symbol}: {e}")
                                                                                                            return None

                                                                                                                def get_signals(self, df):
                                                                                                                        """Estrategia: Cruce EMA 9/21 + RSI."""
                                                                                                                                # Indicadores
                                                                                                                                        df.ta.ema(length=9, append=True)
                                                                                                                                                df.ta.ema(length=21, append=True)
                                                                                                                                                        df.ta.rsi(length=14, append=True)

                                                                                                                                                                last = df.iloc[-1]
                                                                                                                                                                        prev = df.iloc[-2]

                                                                                                                                                                                # L√≥gica de Cruce (Golden Cross / Death Cross)
                                                                                                                                                                                        gold_cross = prev['EMA_9'] <= prev['EMA_21'] and last['EMA_9'] > last['EMA_21']
                                                                                                                                                                                                death_cross = prev['EMA_9'] >= prev['EMA_21'] and last['EMA_9'] < last['EMA_21']

                                                                                                                                                                                                        if gold_cross and last['RSI_14'] > 50:
                                                                                                                                                                                                                    return "COMPRA üü¢ (Bullish Cross)"
                                                                                                                                                                                                                            elif death_cross and last['RSI_14'] < 50:
                                                                                                                                                                                                                                        return "VENTA üî¥ (Bearish Cross)"
                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                        return None

                                                                                                                                                                                                                                                        class TelegramScanner:
                                                                                                                                                                                                                                                            """Clase que gestiona la comunicaci√≥n con el usuario."""
                                                                                                                                                                                                                                                                def __init__(self, engine):
                                                                                                                                                                                                                                                                        self.engine = engine
                                                                                                                                                                                                                                                                                self.active_chats = set()
                                                                                                                                                                                                                                                                                        self.last_signals = {symbol: None for symbol in SYMBOLS}

                                                                                                                                                                                                                                                                                            async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                    chat_id = update.effective_chat.id
                                                                                                                                                                                                                                                                                                            self.active_chats.add(chat_id)
                                                                                                                                                                                                                                                                                                                    await update.message.reply_text(
                                                                                                                                                                                                                                                                                                                                    f"ü§ñ **Scanner Operativo**\nMonitoreando: {', '.join(SYMBOLS)}\nTimeframe: {TIMEFRAME}\n\nRecibir√°s se√±ales autom√°ticamente."
                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                        async def scan_markets(self, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                                """Bucle principal de escaneo."""
                                                                                                                                                                                                                                                                                                                                        for symbol in SYMBOLS:
                                                                                                                                                                                                                                                                                                                                                    df = await self.engine.fetch_data(symbol)
                                                                                                                                                                                                                                                                                                                                                                if df is None or df.empty:
                                                                                                                                                                                                                                                                                                                                                                                continue

                                                                                                                                                                                                                                                                                                                                                                                            signal = self.engine.get_signals(df)
                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                    # Solo enviar si la se√±al es nueva para este s√≠mbolo
                                                                                                                                                                                                                                                                                                                                                                                                                                if signal and signal != self.last_signals[symbol]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                self.last_signals[symbol] = signal
                                                                                                                                                                                                                                                                                                                                                                                                                                                                price = df.iloc[-1]['close']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                msg = (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        f"‚ö†Ô∏è **NUEVA SE√ëAL: {symbol}**\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                f"Acci√≥n: {signal}\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    f"Precio actual: ${price:,.2f}\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        f"RSI: {df.iloc[-1]['RSI_14']:.2f}\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            f"Fecha: {datetime.now().strftime('%H:%M:%S')}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for chat_id in self.active_chats:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await context.bot.send_message(chat_id=chat_id, text=msg, parse_mode='Markdown')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def main():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Inicializar componentes
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            engine = TradingEngine()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                scanner = TelegramScanner(engine)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Configurar Telegram
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app = Application.builder().token(TOKEN).build()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Handlers
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        app.add_handler(CommandHandler("start", scanner.start))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Tarea repetitiva cada 60 segundos
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    job_queue = app.job_queue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        job_queue.run_repeating(scanner.scan_markets, interval=60, first=1)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("Bot en marcha... Esperando se√±ales.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await app.run_polling()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            asyncio.run(main())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except KeyboardInterrupt:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("Bot detenido manualmente.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                    )
)