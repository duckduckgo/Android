name: Production Release to Play Store and Github

on:
  workflow_dispatch:
    inputs:
      app-version:
        description: 'Ref to build APK from (branch, tag, commit)'
        required: true

env:
  ASANA_PAT: ${{ secrets.ASANA_ACCESS_TOKEN }}
  GH_TOKEN: ${{ secrets.GT_DAXMOBILE }}
  GOOGLE_APPLICATION_CREDENTIALS: '#{ENV["HOME"]}/jenkins_static/com.duckduckgo.mobile.android/ddg-upload-firebase.json'

jobs:
  trigger-asana-task-creation:
    name: Trigger Create Asana Task
    uses: ./.github/workflows/release_create_task.yml
    with:
      input: ${{ github.event.inputs.app-version }}

  trigger-tag-creation:
    name: Trigger Create Git Tag
    uses: ./.github/workflows/release_create_tag.yml
    needs: trigger-asana-task-creation
    with:
      ref: ${{ github.event.inputs.app-version }}

  trigger-release-tests:
    name: Trigger Run Release Tests
    uses: ./.github/workflows/release_tests.yml
    needs: trigger-asana-tag-creation
    with:
      ref: ${{ github.event.inputs.app-version }}
      test-tag: 'releaseTest'

  trigger-upload-play-store-github:
    name: Trigger Upload to Play Store and Github
    uses: ./.github/workflows/release_upload_play_store.yml
    needs: trigger-release-tests
    with:
      ref: ${{ github.event.inputs.app-version }}

  trigger-upload-internal:
    name: Trigger Internal Release
    uses: ./.github/workflows/release_upload_internal.yml
    needs: trigger-upload-play-store-github

  trigger-asana-error-task-creation:
    name: Create Asana task when workflow failed
    if: ${{ failure() }}
    uses: duckduckgo/native-github-asana-sync@v2.0
    with:
      asana-project: ${{ vars.GH_ANDROID_APP_PROJECT_ID }}
      asana-section: ${{ vars.GH_ANDROID_APP_INCOMING_SECTION_ID }}
      asana-task-name: GH Workflow Failure - Release Production
      asana-task-description: The Release Production workflow has failed. See https://github.com/duckduckgo/Android/actions/runs/${{ github.run_id }}
      action: 'create-asana-task'
    secrets:
      asana-pat: ${{ secrets.ASANA_ACCESS_TOKEN }}