name: Release - Android App Production Release

on:
  workflow_dispatch:
    inputs:
      app-version:
        description: 'App Version for Release'
        required: true
        default: 'PLACEHOLDER'

env:
  ASANA_PAT: ${{ secrets.ASANA_ACCESS_TOKEN }}
  emoji_info: ":information_source:" # ℹ️
  emoji_success: ":white_check_mark:" # ✅
  emoji_failure: ":x:" # ❌

jobs:
  create_release_task:
    name: Create and Push git tag for version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify Mattermost of Maestro tests
        id: send-mm-tests-started
        uses: duckduckgo/native-github-asana-sync@v1.8
        with:
          mattermost-token: ${{ secrets.MM_AUTH_TOKEN }}
          mattermost-team-id: ${{ secrets.MM_TEAM_ID }}
          mattermost-channel-name: 'david-mattermost-test'
          mattermost-message: ${{env.emoji_info}} Release ${{ github.event.inputs.app-version }}. Running Release Tests https://github.com/duckduckgo/Android/actions/runs/${{ github.run_id }}
          action: 'send-mattermost-message'

      - name: Analyze Maestro Flow Results
        id: analyze-flow-results
        if: always()
        run: |        
          # Default to success, change if issues are found
          final_status="failure" 
          echo "Final determined status: $final_status"
          echo "flow_summary_status=$final_status" >> $GITHUB_OUTPUT

      - name: Notify Mattermost - Maestro Tests ALL SUCCEEDED
        # Condition 1: Our script says success
        # Condition 2: The Maestro action itself also reported overall success
        if: steps.analyze-flow-results.outputs.flow_summary_status == 'success' && steps.release-tests.conclusion == 'success'
        uses: duckduckgo/native-github-asana-sync@v1.8
        with:
          action: 'send-mattermost-message'
          mattermost-token: ${{ secrets.MM_AUTH_TOKEN }}
          mattermost-team-id: ${{ secrets.MM_TEAM_ID }}
          mattermost-channel-name: 'david-mattermost-test'
          mattermost-message: |
            ${{env.emoji_success}} Release ${{ github.event.inputs.app-version }}: All Release Tests PASSED successfully.
            Console: ${{ steps.release-tests.outputs.MAESTRO_CLOUD_CONSOLE_URL }}
            Flow Results: json ${{ steps.release-tests.outputs.MAESTRO_CLOUD_FLOW_RESULTS }}          

      - name: Notify Mattermost - Maestro Tests FAILURES or ISSUES DETECTED
        # Condition: Our script detected 'failure' OR the Maestro action itself reported failure
        if: steps.analyze-flow-results.outputs.flow_summary_status == 'failure' || steps.release-tests.conclusion == 'failure'
        uses: duckduckgo/native-github-asana-sync@v1.8
        with:
          action: 'send-mattermost-message'
          mattermost-token: ${{ secrets.MM_AUTH_TOKEN }}
          mattermost-team-id: ${{ secrets.MM_TEAM_ID }}
          mattermost-channel-name: 'david-mattermost-test'
          mattermost-message: |
            ${{env.emoji_failure}} Release ${{ github.event.inputs.app-version }}: Release Tests FAILED or encountered issues.
            Maestro Action Conclusion: `${{ steps.release-tests.conclusion }}`
            Analyzed Status: `${{ steps.analyze-flow-results.outputs.flow_summary_status }}`
            Console: ${{ steps.release-tests.outputs.MAESTRO_CLOUD_CONSOLE_URL }}
            Flow Results: json ${{ steps.release-tests.outputs.MAESTRO_CLOUD_FLOW_RESULTS }}          

      - name: Notify Mattermost - Maestro Tests  CANCELED Flows Present (Informational or Warning)
        # Condition: Our script detected 'canceled_present' AND no critical 'failure' was found
        # AND Maestro action itself didn't mark the whole run as a 'failure'
        if: steps.analyze-flow-results.outputs.flow_summary_status == 'canceled_present' && steps.release-tests.conclusion != 'failure'
        uses: duckduckgo/native-github-asana-sync@v1.8
        with:
          action: 'send-mattermost-message'
          mattermost-token: ${{ secrets.MM_AUTH_TOKEN }}
          mattermost-team-id: ${{ secrets.MM_TEAM_ID }}
          mattermost-channel-name: 'david-mattermost-test'
          mattermost-message: |
            :warning: Release ${{ github.event.inputs.app-version }}: Some Release Tests were CANCELED. Please review.
            Maestro Action Conclusion: `${{ steps.release-tests.conclusion }}`
            Analyzed Status: `${{ steps.analyze-flow-results.outputs.flow_summary_status }}`
            Console: ${{ steps.release-tests.outputs.MAESTRO_CLOUD_CONSOLE_URL }}
            Flow Results: json ${{ steps.release-tests.outputs.MAESTRO_CLOUD_FLOW_RESULTS }}