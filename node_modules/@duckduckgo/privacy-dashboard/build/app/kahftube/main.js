class Queue {
	constructor() {
		this.elements = {};
		this.head = 0;
		this.tail = 0;
	}
	enqueue(element) {
		this.elements[this.tail] = element;
		this.tail++;
	}
	dequeue() {
		const item = this.elements[this.head];
		delete this.elements[this.head];
		this.head++;
		return item;
	}
	peek() {
		return this.elements[this.head];
	}
	get length() {
		return this.tail - this.head;
	}
	get isEmpty() {
		return this.length === 0;
	}
}

const apiQueue = new Queue();
let mode;
let gender;
let metaData;

function check_gender(response_gender, gender) {
	if (response_gender == 1) return true;
	if (response_gender == 4) return true; //Kids items are halal for both male and female.
	return response_gender == gender;
}

function check_mode(response_mode, mode) {
	switch (mode) {
		case 2:
			return true;
		case 3:
			return response_mode == 3 || response_mode == 1;
		case 1:
			return response_mode === 1;
		default:
			return false;
	}
}

function can_see(response) {
	return (
		check_gender(response.permissible_for.value, gender) &&
		check_mode(response.practicing_level.value, mode)
	);
}

async function canSeee(responsee) {
	if (responsee["type"]) {
		return true;
	}
	return can_see(responsee);
}

let timerId;
let apiRequestCount = 0;
let email;
let token;

const throttle = () => {
	if (!timerId) {
		apiQueue.peek()();
		apiQueue.dequeue();
		timerId = setTimeout(() => {
			apiRequestCount = 0;
			clearTimeout(timerId);
			timerId = null;
		}, 500);
	}
};

setInterval(() => {
	if (!apiQueue.isEmpty) {
		throttle();
	}
}, 0);

const apiResponses = {};
const imageUrls = {};
/*const restrictionImageUrl =
  "http://localhost:8080/assets/images/img_do_not_enter.jpeg";
const loadingImageUrl = "http://localhost:8080/assets/images/loading.gif";
const cautionImageUrl = "http://localhost:8080/assets/images/caution.png";*/
const kahfTubeImageUrl = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjU4IiBoZWlnaHQ9IjQ3OSIgdmlld0JveD0iMCAwIDY1OCA0NzkiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMF8yM18xMDQpIj4KPHBhdGggZD0iTTMxNC40NCAzNzYuNjRDMjg3LjkgMzc2LjY0IDI3MC4xIDM5NS42OSAyNzAuNjcgNDIwLjU3VjQ3OC40N0gyOTIuMzRWNDQ4LjE0SDI5OC4xNUMzMTAuMTIgNDQ4LjE0IDMxOS44MiA0MzguNDQgMzE5LjgyIDQyNi40N0gyOTIuMzRWNDIwLjIyQzI5Mi4yOSA0MTguODMgMjkyLjAxIDM5OC4zIDMxNC40NCAzOTguM0MzMTguNyAzOTguMyAzMjIuNSAzOTUuNjEgMzIzLjkyIDM5MS41OUwzMjkuMjEgMzc2LjYzSDMxNC40NFYzNzYuNjRaIiBmaWxsPSIjQTI0MkZGIi8+CjxwYXRoIGQ9Ik0xOTQuMjYgNDc4LjQ3SDE3Mi41OVYzNzcuOTRDMTg0LjU2IDM3Ny45NCAxOTQuMjYgMzg3LjY0IDE5NC4yNiAzOTkuNjFWNDA1LjM2QzE5OS40MyA0MDIuNTQgMjA1LjM0IDQwMC45NCAyMTEuNzUgNDAwLjkxQzIzNi42MyA0MDAuMzEgMjU1LjcgNDE4LjE1IDI1NS43IDQ0NC42OFY0NzguNDhIMjM0LjAzVjQ0Mi44NEMyMzQuMDMgNDMxLjg0IDIyNS4xMiA0MjIuOTMgMjE0LjEyIDQyMi45M0MyMDMuMTEgNDIyLjkzIDE5NC4yIDQzMS44NiAxOTQuMjEgNDQyLjg2TDE5NC4yNSA0NzguNDhMMTk0LjI2IDQ3OC40N1oiIGZpbGw9IiNBMjQyRkYiLz4KPHBhdGggZD0iTTAgMzc3Ljk0VjQ3OC40N0gyMS42N1Y0NTkuMzNMMzMuMzcgNDQ1LjlMNDcuMzUgNDcwLjMyQzUwLjIxIDQ3NS4zMSA1NS41MSA0NzguNCA2MS4yNyA0NzguNDJMNzYuOTkgNDc4LjQ3TDQ3LjkgNDI5LjY1TDc2LjIzIDM5Ni45NUg1OS4wNEM1My44OSAzOTYuOTUgNDkgMzk5LjIyIDQ1LjY4IDQwMy4xNUwyMS42NyA0MzEuNTlWMzk5LjZDMjEuNjcgMzg3LjY0IDExLjk3IDM3Ny45NCAwIDM3Ny45NFoiIGZpbGw9IiNBMjQyRkYiLz4KPHBhdGggZD0iTTExOC4zOCAzOTUuNjhDOTUuNTIgMzk1LjY4IDc2Ljk5IDQxNC4yMSA3Ni45OSA0MzcuMDdDNzYuOTkgNDU5LjkzIDk1LjUyIDQ3OC40NiAxMTguMzggNDc4LjQ2QzEyNS41MiA0NzguNDYgMTMyLjI0IDQ3Ni42NSAxMzguMTEgNDczLjQ3VjQ3OC40NkgxNTkuNzhWNDM3LjA3QzE1OS43OCA0MTQuMjEgMTQxLjI1IDM5NS42OCAxMTguMzkgMzk1LjY4SDExOC4zOFpNMTM4LjExIDQzNy4wN0wxMzcuNTQgNDU2LjVDMTM3LjUxIDQ1Ny40MiAxMzYuNDEgNDU3Ljg2IDEzNS43NiA0NTcuMjJMMTMwLjgzIDQ1Mi4zOEMxMjcuMDkgNDU1LjQyIDEyMi4yMiA0NTcuMTMgMTE2Ljk1IDQ1Ni43NUMxMDcuNjcgNDU2LjA5IDk5LjkgNDQ4LjcyIDk4LjgxIDQzOS40N0M5Ny4xMyA0MjUuMjIgMTEwLjY1IDQxMy41MyAxMjUuMjggNDE4LjUxQzEzMy4xIDQyMS4xNyAxMzguMTIgNDI4LjgxIDEzOC4xMiA0MzcuMDdIMTM4LjExWiIgZmlsbD0iI0EyNDJGRiIvPgo8cGF0aCBkPSJNMzI2LjMgLTYuODQyODllLTA2QzIzNC40NSAwLjU2OTk5MyAxNjAuNjUgNzcuMjQgMTY0Ljc3IDE3MC4xNEMxNjguNDUgMjUzLjA1IDIzNS4zNyAzMjAuNjkgMzE4LjI0IDMyNS4yQzM0OS43IDMyNi45MSAzNzkuMzUgMzE5LjY4IDQwNC44OCAzMDUuODFWMzUxLjc3TDQxOS44NyAzNDMuNjZDNDYzLjExIDMyMC4yNyA0OTAuMDUgMjc1LjA2IDQ5MC4wNSAyMjUuOVYxNjUuMzhDNDkwLjA1IDc0LjY4IDQxNyAtMC41NjAwMDcgMzI2LjMgLTYuODQyODllLTA2Wk00MDQuODggMTYyLjcyTDQwMi4zNiAyNDguNTJMMzc2LjI0IDIyMi44N0MzNjAuODMgMjM1LjQxIDM0MC41NCAyNDIuMTggMzE4LjY0IDIzOS43OUMyODQuMjMgMjM2LjA0IDI1My44OCAyMDUuNjIgMjUwLjIzIDE3MS4xOUMyNDQuMzQgMTE1LjYgMjk3LjIyIDcwLjMgMzU0LjQxIDg5Ljc1QzM4NC43OSAxMDAuMDggNDA0Ljg4IDEyOS4wNSA0MDQuODggMTYxLjE0VjE2Mi43MVYxNjIuNzJaIiBmaWxsPSIjQTI0MkZGIi8+CjxwYXRoIGQ9Ik0zMDkuNjcgMTMyLjExVjE5My4wOUwzNjIuNiAxNjIuNkwzMDkuNjcgMTMyLjExWiIgZmlsbD0iI0EyNDJGRiIvPgo8cGF0aCBkPSJNNTIzLjk0IDQzMC4xNVY0NDYuNjFMNTM4LjIzIDQzOC4zOEw1MjMuOTQgNDMwLjE1WiIgZmlsbD0iIzNDM0Y0NCIvPgo8cGF0aCBkPSJNNjMyLjc0IDQyNi4yQzYyNS41NyA0MTcuNjggNjExLjU3IDQxNi4xNSA2MDMuMzYgNDI2LjJINjMyLjc0Wk02NTAuMTEgNDYyLjVDNjM2Ljc4IDQ4MC4xOCA2MTEuNjUgNDgzLjcyIDU5My45NiA0NzAuMzlDNTc2LjI4IDQ1Ny4wNiA1NzIuNzQgNDMxLjkzIDU4Ni4wNyA0MTQuMjRDNjA1LjE4IDM4OC44OCA2NDEuMjcgMzk1LjcgNjUzLjgzIDQyMC4yN0M2NTYuMzkgNDI1LjI3IDY1Ny42MSA0MzAuODUgNjU3LjYxIDQzNi40N1Y0NDcuMTlINjAxLjE3QzYwNS42IDQ1NC44NyA2MTUuMyA0NTkuNjUgNjI0LjA1IDQ1Ni44QzYzMi44IDQ1My45NSA2NDEuNTIgNDU2LjAyIDY0OC41IDQ2MS4yOUw2NTAuMTEgNDYyLjUxVjQ2Mi41WiIgZmlsbD0iIzNDM0Y0NCIvPgo8cGF0aCBkPSJNMzk3LjU4IDM5Ny40NUM0MDkuMTcgMzk3LjQ1IDQxOC41NyA0MDYuODUgNDE4LjU3IDQxOC40NFY0MzQuOEM0MTguNTcgNDU2LjUyIDQzOC40NSA0NTYuMjUgNDM5LjggNDU2LjIxQzQ0OC4wMSA0NTYuMjEgNDU3LjEgNDQ4Ljc0IDQ1Ny4xIDQzNC44VjM5Ny40NUM0NjguNjkgMzk3LjQ1IDQ3OC4wOSA0MDYuODUgNDc4LjA5IDQxOC40NFY0MzQuOEM0NzguMDkgNDU3Ljc0IDQ2Mi4yNSA0NzcuMDkgNDQwLjE2IDQ3Ny4xOUM0MTYuMDYgNDc3Ljc3IDM5Ny41OSA0NjAuNDkgMzk3LjU5IDQzNC44VjM5Ny40NUgzOTcuNThaIiBmaWxsPSIjM0MzRjQ0Ii8+CjxwYXRoIGQ9Ik0zODcuNTggNDc2LjU3SDM4MC42OUMzNTQuOTggNDc2LjU3IDMzNy43NSA0NTguMTIgMzM4LjMgNDM0LjAyVjM3Ny45NEgzMzguNjlDMzUwLjA2IDM3Ny45NCAzNTkuMjkgMzg3LjE2IDM1OS4yOCAzOTguNTRWNDA3LjMySDM4NS45QzM4NS45IDQxOC45MSAzNzYuNSA0MjguMzEgMzY0LjkxIDQyOC4zMUgzNTkuMjhWNDM0LjM2QzM1OS4yOCA0MzQuMzYgMzU5LjI3IDQzNS44MSAzNTkuNTMgNDM3LjczQzM2MS4xNSA0NDkuNDEgMzY3Ljg4IDQ1NS41OSAzODAuNjkgNDU1LjU5SDM4Ny41OFY0NzYuNTdaIiBmaWxsPSIjM0MzRjQ0Ii8+CjxwYXRoIGQ9Ik01MjguMDYgNDc4LjQ3QzU1MS40MiA0NzguNjUgNTcwLjIxIDQ1OC44NSA1NjguMzQgNDM1LjEzQzU2Ni43OCA0MTUuMjcgNTUwLjQ1IDM5OS40IDUzMC41NiAzOTguMzVDNTIyLjgzIDM5Ny45NCA1MTUuNTQgMzk5LjcyIDUwOS4yNyA0MDMuMTNWMzk4LjkzQzUwOS4yNyAzODcuMzQgNDk5Ljg3IDM3Ny45NCA0ODguMjggMzc3Ljk0VjQzNy42MUM0ODguMjggNDU5LjQ5IDUwNi4xNyA0NzguMyA1MjguMDYgNDc4LjQ3Wk01MjguMzggNDU3LjQ5QzUxNy44MyA0NTcuNDkgNTA5LjI3IDQ0OC45MyA1MDkuMjcgNDM4LjM4QzUwOS4yNyA0MjcuODMgNTE3LjgyIDQxOS4yNyA1MjguMzggNDE5LjI3QzUzOC45NCA0MTkuMjcgNTQ3LjQ5IDQyNy44MiA1NDcuNDkgNDM4LjM4QzU0Ny40OSA0NDguOTQgNTM4Ljk0IDQ1Ny40OSA1MjguMzggNDU3LjQ5WiIgZmlsbD0iIzNDM0Y0NCIvPgo8L2c+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzIzXzEwNCI+CjxyZWN0IHdpZHRoPSI2NTcuNiIgaGVpZ2h0PSI0NzguNDciIGZpbGw9IndoaXRlIi8+CjwvY2xpcFBhdGg+CjwvZGVmcz4KPC9zdmc+Cg==";
const restrictionImageUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALoAAACUCAMAAAATdsOFAAAAY1BMVEX///8AAABGRkb8/Pxqamq2trbm5ub5+fmUlJQTExPz8/PX19fv7+/s7OwbGxvIyMiNjY0hISGmpqY6Ojrf399AQEBycnKdnZ19fX28vLwtLS2Dg4NiYmJLS0vPz89cXFxTU1N1fC1jAAAFIElEQVR4nO2caZeqMAyGQUCkOGyyDIvo//+V17FtilDAcVLoPafvJ8fhhIcuIU1TLcvIyMjIyMjIyMjIyMjIyMhoUSSuTupU1UQV+NFtUlulouYWKgH/VorN1eHDx8Um5LadZg4yudqh8qIWlTy8bEeOy368bUlu2yc0cufETDbfoa9OYcv7Nqix0MOIWjzEWBZnlHMvdvvCMegk1F7R49hbkM/710Oyx8yh9eLSvVi7Fz6KuZhaS5D9rVzcI+Qo1uh4Sbdo9Ic8il6hGLs/bd2PKMZWldPbdSjGDk9b7ibj5THaXerNUIxti+4Y9KcM+lN5nVVVVi+4Pk3R4/L6DJ7TezK7otAT/TsSwWE694bTET0fxfyXs/QyDdHZq2agQhoe6ofO3jQv+pbFWPqhZwAciE+y0FY/dGjp3Cch7wFXMmS0Q2fxYMNWKzVjlyy7tEOnPEHG/64oejU1qh06dYx3mJdfNCNVTrOMuqH7DR3o8AVp6bNMfbum6In4gq6fD9N5qil6CV+wVr/p3+oWHdoFLBJzNoL0H+tWST0KZORYziKbXqkdek9RA7bQZ0mp4H/w6xaPdwsvD7OG/SHxjRqiszzUi1JZDlM/dL+dokvTRPqhW+duTF5K84oaoltkFLFLo3U90R/hYwPcwWUuDa0nunWu3GsTBM3VzeQLU0tb9MdszWPPi/OF7Lm26Osy6FQG/U3tju58vI21NzpJrp/ebWf0sPh8M2hXdFIthCir2hMdclvJR+z7ofuZyEV/VGCxGzrpRDb0s33bvdDHa6HFKoXkINtS2gddVLY1bNQsFLacy8dCVZdldX3g5Pe4Z+yXuRKa/FnGkE6zGTugkxYq207HBxr7fJFv1fVX7obGZrdH78VWUf28kg/7RrZjNCjgGyfAtkYnCaCUHBWm7NS9V8OpfHjtl43RQ1jtF4PB6/GSsVG7k1Fe47XSZlN04oEvd4ct6PCtr+6F/QiZAXjg4WTdEj0vOUE0Wiz7fGCUg+9DPkHtWDjTRFywIXoNM07iTPhTiXrRmCc0msfVPkwRF9g3QyfQ6VEi+z8f1nxTACYo6wh48IA/90bofg2x1l3+7jnzdq9+/IxwRAkf/r0YP86G6F9JOkGZXMPLgTNHPMcwLsuh3yqyGXoMDRbF86E522a0oxogXyMb4Sufb6ct0CuobrktnrHgxakR76LLuMAWJkBBtkAP4cXfrNXfHkWW9EfdNNQFt2OHfGNbGTrJYJSX64cr+mERj2TTbtgQnl8qRc/FkZPsnQM5olXtk3xWfHGLUXJXie5BK97erAvnlRjR7BkSwsu/g0AdunBxwftrflpUMrvw+BF/PFsVutOD9etvSvF/vMh1+SxAWChFP/J+tdP2V4cSnERE8nPKXYXoPRyVudS/zPySN07YnVtl6BV4inJ2L+hP8jMl6BYB5ystlcMRX7Vionc1NLmLc5BCLjZZMdEjHrKk8xuHKMIPBMAlKjkSKqQg/GJK1Da5OnTlR9mUof/uLfSZlKBfJJVa+FKB7iqen0wK0DucA32r2nvf9A8y6FQG/U0ZdCq6vLiqDBcHQj20ydZ0OOduV3XEPCrLNuMWl/N4YssCnIbyWdql2aLdeQEt0sF/yJBEbZwflQrW7Ui/ckMgabSZ0E7+59f1m6EqxQv18sP67TB1QnyJjMug1erD2qs59fdo/Z4oStE9mRO3XZEGahUVXavktX3ua0+t6l7Zb38ZGRkZGRkZGRkZGRkZGRkJ/QP0HkeQHvo5hgAAAABJRU5ErkJggg==";
const loadingImageUrl = "https://cdn.cssauthor.com/wp-content/uploads/2018/06/Silver-Balls-Swinging.gif?strip=all&lossy=1&resize=800%2C600&ssl=1";
const cautionImageUrl = "data:image/jpeg;base64,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";


setInterval(() => {
	if (document.getElementsByClassName("ytp-ad-text").length > 0) {
		const video = document.getElementsByClassName(
			"video-stream html5-main-video"
		)[0];
		video.play();
		video.pause();
		video.currentTime = video.duration;
	}
}, 200);

new MutationObserver(async (mutationList, observer) => {
	if (!mode || !gender) {
		/*const pref = await window.flutter_inappwebview.callHandler("pref");
		mode = pref["mode"];
		gender = pref["gender"];
		token = pref["token"];*/

		token = KahfTubeInterface.getUserToken();
		mode = KahfTubeInterface.getUserPracticingLevel();
		gender = KahfTubeInterface.getUserGender();

		/*token = "1637|VTwoGKekKw5uLze11HEwQc1kExtFnkuqts0chlOw1c46b4ff"
		mode = 1
		gender = 2*/
		if(token == ""){
		    token = "1637|VTwoGKekKw5uLze11HEwQc1kExtFnkuqts0chlOw1c46b4ff"
		}

		console.log("userPref:", token)
		console.log("userPref:", mode)
		console.log("userPref:", gender)
	}

	if (location.href == "https://m.youtube.com/?noapp=1") {
		email = null;
		isSigninClicked = false;
		isButtonClicked = false;
		//window.flutter_inappwebview.callHandler("shouldRestart", "svg");
		KahfTubeInterface.shouldRestart();
	}

	/*const reelSections = document.getElementsByTagName("ytm-reel-shelf-renderer");
	for (let index = 0; index < reelSections.length; index++) {
	  const element = reelSections[index];
	  element?.remove();
	}*/

	removeReelsOrShorts()
	updateFeaturedVideo();
	updateCardVideo();
	updateCompactVideoList();
	updateMediaItemList();
}).observe(document.getElementById("app"), {
	attributes: true,
	subtree: true,
	characterData: false,
	childList: true,
});

function removeReelsOrShorts() {
	const reelSections = document.getElementsByTagName("ytm-rich-section-renderer");
	//reelSections?.remove()
	for (let index = 0; index < reelSections.length; index++) {
		const element = reelSections[index];
		element?.remove();
	}
}

function updateElementsWhenNecessary(
	imageElement,
	imageUrl,
	elementsToBeActionable = [],
	action
) {
	if (imageElement.getAttribute("src") == imageUrl) {
		return;
	}
	elementsToBeActionable.forEach((element) => {
		element.style.pointerEvents = action;
	});
	if (imageUrl) {
		imageElement.removeAttribute("src");
		imageElement.setAttribute("src", imageUrl);
	}
}

async function getParamsBasedOnResponse(response) {
	if (response == 404) {
		return {
			imageUrl: cautionImageUrl,
			action: "",
		};
	} else if (response?.is_halal || response?.type) {
		if (await canSeee(response)) {
			return {
				action: "",
			};
		} else {
			return {
				imageUrl: restrictionImageUrl,
				action: "none",
			};
		}
	} else if (response == "loading") {
		return {
			imageUrl: loadingImageUrl,
			action: "none",
		};
	} else {
		return {
			imageUrl: restrictionImageUrl,
			action: "none",
		};
	}
}

// function updateReelVideo() {
//   const reelList = document.querySelectorAll("a.reel-item-endpoint");

//   for (let index = 0; index < reelList.length; index++) {
//     const element = reelList[index];
//     const href = element?.getAttribute("href");
//     const image = element?.children?.item(0)?.children?.item(1);
//     const updateView = async () => {
//       const response = apiResponses[href];
//       const { imageUrl, action } = await getParamsBasedOnResponse(response);
//       if (imageUrl) {
//         updateElementsWhenNecessary(image, imageUrl, [element], action);
//       } else {
//         if (element.style.pointerEvents == "none") {
//           element.style.pointerEvents = "";
//         }
//       }
//     };
//     updateApiResponse(href, updateView);
//     updateView();
//   }
// }

function updateFeaturedVideo() {
	const element = document.querySelector("ytm-channel-featured-video-renderer");
	const a = element?.children?.item(0);
	const image = a?.children?.item(0)?.children?.item(1);
	const href = a?.getAttribute("href");
	const updateView = async () => {
		const response = apiResponses[href];
		const {
			imageUrl,
			action
		} = await getParamsBasedOnResponse(response);
		if (imageUrl) {
			if (imageUrl == restrictionImageUrl) {
				element?.remove();
			} else {
				updateElementsWhenNecessary(
					image,
					imageUrl == cautionImageUrl ? imageUrls[href] : imageUrl,
					[a],
					action
				);
				updateCautionView(imageUrl, image, a);
			}
		} else {
			if (a.style.pointerEvents == "none") {
				a.style.pointerEvents = "";
				image?.removeAttribute("src");
				image?.setAttribute("src", imageUrls[href]);
			}
			if (response.type) {
				if (image.getAttribute("src") != response.metaData.thumbnail) {
					image?.removeAttribute("src");
					image?.setAttribute("src", response.metaData.thumbnail);
				}
				if (a.href !== response.url) {
					apiResponses[response.url] = response;
					a.href = response.url;
				}
				const title = a.querySelector("h3.details");
				if (title && title.children.item(0).textContent !== response.title) {
					title.textContent = response.title;
				}
			}
		}
	};

	if (href && !apiResponses[href]) {
		apiResponses[href] = "loading";
		let ogImage = image?.lazyData?.sources?.find((el) =>
			el["url"].includes("mqdefault")
		);
		// console.log(ogImage);
		ogImage = ogImage ?? image?.lazyData?.sources[0];
		imageUrls[href] = ogImage?.url;
		const cUrl = document.querySelector("ytm-c4-tabbed-header-renderer")?.data
			?.channelId;
		updateApiResponse([href], [cUrl], updateView);
	} else {
		updateView();
	}
}

function updateCardVideo() {
	const cardVideo = document.querySelector("a.watch-card-hero-video-endpoint");
	const href = cardVideo?.getAttribute("href");
	const image = cardVideo?.children?.item(0)?.children?.item(0);
	const updateView = async () => {
		const response = apiResponses[href];
		const {
			imageUrl,
			action
		} = await getParamsBasedOnResponse(response);
		if (imageUrl) {
			if (imageUrl == restrictionImageUrl) {
				cardVideo?.parentElement?.parentElement?.remove();
			} else {
				updateElementsWhenNecessary(
					image,
					imageUrl == cautionImageUrl ? imageUrls[href] : imageUrl,
					[cardVideo],
					action
				);
				updateCautionView(imageUrl, image, cardVideo);
			}
		} else {
			if (cardVideo.style.pointerEvents == "none") {
				cardVideo.style.pointerEvents = "";
				image?.removeAttribute("src");
				image?.setAttribute("src", imageUrls[href]);
			}
			if (response.type) {
				if (image.getAttribute("src") != response.metaData.thumbnail) {
					image?.removeAttribute("src");
					image?.setAttribute("src", response.metaData.thumbnail);
				}
				if (cardVideo.href !== response.url) {
					apiResponses[response.url] = response;
					cardVideo.href = response.url;
				}
				const title = cardVideo.querySelector(
					"h2.watch-card-single-hero-title"
				);
				if (title && title.children.item(0).textContent !== response.title) {
					title.textContent = response.title;
				}
				const sub = cardVideo?.children?.item(1)?.children?.item(1);
				const textContent = `${response.channel.title} • ${response.metaData.views} • ${response.published_at}`;
				if (sub.textContent !== textContent) {
					sub.textContent = textContent;
				}
				const timeLine = cardVideo.querySelector(
					"span.yt-core-attributed-string"
				);
				if (timeLine.textContent !== response.metaData["timeline"]) {
					timeLine.textContent = response.metaData["timeline"];
				}
			}
		}
	};

	if (href && !apiResponses[href]) {
		apiResponses[href] = "loading";
		let ogImage = image?.lazyData?.sources?.find((el) =>
			el["url"].includes("mqdefault")
		);
		ogImage = ogImage ?? image?.lazyData?.sources[0];
		imageUrls[href] = ogImage?.url;
		const cUrl = cardVideo?.baseURI.split("/");
		updateApiResponse(
			[href],
			[cUrl.find((el) => el.startsWith("@"))],
			updateView
		);
	} else {
		updateView();
	}
}

async function updateCompactVideo(node) {
	const thumbnail = node?.children?.item(0);
	const image = thumbnail.children?.item(0)?.children?.item(1);
	const details = node?.children?.item(1)?.children?.item(0);
	const href = thumbnail?.getAttribute("href");
	const response = apiResponses[href];
	const {
		imageUrl,
		action
	} = await getParamsBasedOnResponse(response);
	// console.log(href, " ------ ", imageUrl);
	if (imageUrl) {
		if (imageUrl == restrictionImageUrl) {
			node.parentElement?.remove();
		} else {
			updateElementsWhenNecessary(
				image,
				imageUrl == cautionImageUrl ? imageUrls[href] : imageUrl,
				[thumbnail, details],
				action
			);
			updateCautionView(imageUrl, image, thumbnail, false);
		}
	} else {
		if (thumbnail.style.pointerEvents == "none") {
			thumbnail.style.pointerEvents = "";
			details.style.pointerEvents = "";
			image?.removeAttribute("src");
			image?.setAttribute("src", imageUrls[href]);
		}
		if (response.type) {
			if (image.getAttribute("src") != response.metaData.thumbnail) {
				image?.removeAttribute("src");
				image?.setAttribute("src", response.metaData.thumbnail);
			}
			if (thumbnail.href !== response.url) {
				apiResponses[response.url] = response;
				thumbnail.href = response.url;
			}
			if (details.href !== response.url) {
				details.href = response.url;
			}
			const title = details.querySelector("h4.compact-media-item-headline");
			if (title && title.children.item(0).textContent !== response.title) {
				title.textContent = response.title;
			}
			const sub = details?.children?.item(1);
			const textContent = `${response.channel.title} • ${response.metaData.views} • ${response.published_at}`;
			if (sub.textContent !== textContent) {
				sub.textContent = textContent;
			}
			const timeLine = node.querySelector("span.yt-core-attributed-string");
			if (timeLine.textContent !== response.metaData["timeline"]) {
				timeLine.textContent = response.metaData["timeline"];
			}
		}
	}
}

let compactItemLength = 0;

function updateCompactVideoList() {
	let compactVideoList = document.querySelectorAll("div.compact-media-item");
	if (!compactVideoList.length) {
		compactVideoList = document.querySelectorAll(
			"ytm-video-card-renderer.horizontal-card-list-card"
		);
	}
	const updateView = () => {
		for (let index = 0; index < compactVideoList.length; index++) {
			updateCompactVideo(compactVideoList[index]);
		}
	};

	if (compactItemLength != compactVideoList.length) {
		// console.log(compactVideoList.length);
		compactItemLength = compactVideoList.length;
		const hrefs = [];
		const chrefs = [];
		for (let index = 0; index < compactVideoList.length; index++) {
			const thumbnail = compactVideoList[index]?.children?.item(0);
			const image = thumbnail.children?.item(0)?.children?.item(1);
			const href = thumbnail?.getAttribute("href");
			if (!apiResponses[href]) {
				hrefs.push(href);

				const cUrl = document.querySelector("ytm-c4-tabbed-header-renderer")
					?.data?.channelId;
				chrefs.push(cUrl);
				apiResponses[href] = "loading";
				let ogImage = image?.lazyData?.sources?.find((el) =>
					el["url"].includes("mqdefault")
				);
				ogImage = ogImage ?? image?.lazyData?.sources[0];
				imageUrls[href] = ogImage?.url;
			}
		}
		updateApiResponse(hrefs, chrefs, updateView);
	} else {
		updateView();
	}
}

let mediaItemLength = 0;

function updateMediaItemList() {
	const videoList = document.getElementsByTagName("ytm-media-item");

	const updateView = () => {
		for (let index = 0; index < videoList.length; index++) {
			if (videoList[index]?.className?.includes("big-shorts-singleton")) {
				videoList[index]?.remove();
				continue;
			}
			updateMediaItem(videoList[index]);
		}
	};

	if (mediaItemLength != videoList.length) {
		// console.log(videoList.length);
		mediaItemLength = videoList.length;
		const hrefs = [];
		const chrefs = [];
		for (let index = 0; index < videoList.length; index++) {
			if (videoList[index]?.className?.includes("big-shorts-singleton")) {
				videoList[index]?.remove();
				continue;
			}
			const thumbnail = videoList[index]?.children?.item(0);
			const href = thumbnail?.getAttribute("href");
			const image = thumbnail?.children?.item(0)?.children?.item(1);
			const channelInfo = videoList[index]?.children
				?.item(videoList[index].children.length - 1)
				?.children?.item(0);
			if (!apiResponses[href]) {
				hrefs.push(href);
				const channelLink = channelInfo?.children?.item(0)?.children?.item(0)
					?._data?.browseEndpoint?.browseId;
				chrefs.push(channelLink);
				apiResponses[href] = "loading";
				let ogImage = image?.qC?.sources.find((el) =>
					el["url"].includes("sddefault")
				);
				ogImage = ogImage ?? image?.qC?.sources[0];
				imageUrls[href] = ogImage?.url;
			}
		}
		updateApiResponse(hrefs, chrefs, updateView);
	} else {
		updateView();
	}
}

async function updateMediaItem(node) {
	const thumbnail = node?.children?.item(0);
	const image = thumbnail?.children?.item(0)?.children?.item(1);
	const details = node?.children
		?.item(node.children.length - 1)
		?.children?.item(1)
		?.children?.item(0)
		?.children?.item(0);
	const href = thumbnail?.getAttribute("href");

	const response = apiResponses[href];
	const {
		imageUrl,
		action
	} = await getParamsBasedOnResponse(response);
	if (imageUrl) {
		if (imageUrl == restrictionImageUrl) {
			node?.remove();
		} else {
			updateElementsWhenNecessary(
				image,
				imageUrl == cautionImageUrl ? imageUrls[href] : imageUrl,
				[thumbnail, details],
				action
			);
			updateCautionView(imageUrl, image, thumbnail);
			if (imageUrl == cautionImageUrl) {
				const channelThumb = node
					.querySelector("ytm-profile-icon.channel-thumbnail-icon")
					?.children?.item(0);
				if (channelThumb.style.filter != "blur(1.1rem)") {
					channelThumb.style.filter = "blur(1.1rem)";
				}
			}
		}
	} else {
		if (thumbnail.style.pointerEvents == "none") {
			thumbnail.style.pointerEvents = action;
			details.style.pointerEvents = action;
			image?.removeAttribute("src");
			image?.setAttribute("src", imageUrls[href]);
		}
		if (response.type) {
			if (image.getAttribute("src") != response.metaData.thumbnail) {
				image?.removeAttribute("src");
				image?.setAttribute("src", response.metaData.thumbnail);
			}
			if (thumbnail.href !== response.url) {
				apiResponses[response.url] = response;
				thumbnail.href = response.url;
			}
			if (details.href !== response.url) {
				details.href = response.url;
			}
			const title = details.querySelector("h3.media-item-headline");
			if (title && title.children.item(0).textContent !== response.title) {
				title.textContent = response.title;
			}
			const channelInfo = node?.children
				?.item(node.children.length - 1)
				?.children?.item(0);
			const channelLink = channelInfo?.children?.item(0)?.children?.item(0);
			if (channelLink.href != response.channel.url) {
				channelLink.href = response.channel.url;
			}
			const channelThumb = node.querySelector(
				"ytm-profile-icon.channel-thumbnail-icon"
			);
			if (channelThumb.children.length == 1) {
				const innerHtml = `<img src="${response.channel.thumbnails.default.url}">`;
				if (channelThumb.innerHTML != innerHtml) {
					channelThumb.innerHTML = innerHtml;
				}
			}
			const hiddenVideoLink = channelInfo?.children?.item(1);
			if (hiddenVideoLink.href !== response.url) {
				hiddenVideoLink.href = response.url;
			}
			const sub = details?.children?.item(1);
			const textContent = `${response.channel.title} • ${response.metaData.views} • ${response.published_at}`;
			if (sub.textContent !== textContent) {
				sub.textContent = textContent;
			}
			const timeLine = node.querySelector("span.yt-core-attributed-string");
			if (timeLine.textContent !== response.metaData["timeline"]) {
				timeLine.textContent = response.metaData["timeline"];
			}
		}
	}
}

function updateCautionView(
	imageUrl,
	imageElement,
	thumbnailElement,
	isLargeView = true
) {
	if (imageUrl == cautionImageUrl) {
		if (imageElement.style.filter != "blur(1.1rem)") {
			imageElement.style.filter = "blur(1.1rem)";
		}
		if (thumbnailElement.children.item(0).children.length <= 4) {
			thumbnailElement.children
				.item(0)
				.append(
					isLargeView ?
					createLargeCautionElement() :
					createCompactCautionElement()
				);
		}
	}
}

function createCompactCautionElement() {
	const div1 = document.createElement("div");
	div1.style.position = "absolute";
	div1.style.display = "flex";
	div1.style.width = "100%";
	div1.style.alignItems = "center";
	div1.style.justifyContent = "center";
	div1.style.bottom = "15%";
	div1.style.flexDirection = "column";
	const div2 = document.createElement("div");
	div2.style.background = "#FFFFFF";
	div2.style.boxShadow = "0px 4px 12px rgba(53, 53, 55, 0.82)";
	div2.style.borderRadius = "5px";
	const p = document.createElement("p");
	p.style.fontFamily = "Roboto";
	p.style.fontStyle = "normal";
	p.style.fontWeight = 500;
	p.style.fontSize = "0.9rem";
	p.style.lineHeight = "1rem";
	p.style.color = "#383838";
	p.style.margin = "0.5rem";
	p.textContent = "See Video (Not Recommended)";
	div2.append(p);
	div1.append(div2);
	const p1 = document.createElement("p");
	p1.style.color = "#FFFFFF";
	p1.textContent =
		"This video is not avaialable on our database. Proceed with caution";
	p1.style.fontFamily = "Roboto";
	p1.style.fontStyle = "normal";
	p1.style.fontWeight = 400;
	p1.style.fontSize = "0.8rem";
	p1.style.textAlign = "center";
	p1.style.lineHeight = "1rem";
	div1.append(p1);
	return div1;
}

function createLargeCautionElement() {
	const div1 = document.createElement("div");
	div1.style.position = "absolute";
	div1.style.display = "flex";
	div1.style.width = "100%";
	div1.style.alignItems = "center";
	div1.style.justifyContent = "center";
	div1.style.bottom = "31%";
	div1.style.flexDirection = "column";
	const div2 = document.createElement("div");
	div2.style.background = "#FFFFFF";
	div2.style.boxShadow = "0px 4px 12px rgba(53, 53, 55, 0.82)";
	div2.style.borderRadius = "5px";
	const p = document.createElement("p");
	p.style.fontFamily = "Roboto";
	p.style.fontStyle = "normal";
	p.style.fontWeight = 500;
	p.style.fontSize = "1.3";
	p.style.lineHeight = "1.5rem";
	p.style.color = "#383838";
	p.style.margin = "1.5rem";
	p.textContent = "See Video (Not Recommended)";
	div2.append(p);
	div1.append(div2);
	const p1 = document.createElement("p");
	p1.style.color = "#FFFFFF";
	p1.textContent =
		"This video is not avaialable on our database. Proceed with caution";
	p1.style.fontFamily = "Roboto";
	p1.style.fontStyle = "normal";
	p1.style.fontWeight = 400;
	p1.style.fontSize = "1.1rem";
	p1.style.textAlign = "center";
	p1.style.lineHeight = "1.4rem";
	div1.append(p1);
	return div1;
}

function updateApiResponse(hrefs, chrefs, callback) {
	if (hrefs) {
		const re = new RegExp(
			".*(?:(?:youtu.be/|v/|vi/|u/w/|embed/)|(?:(?:watch)??v(?:i)?=|&v(?:i)?=))([^#&?]*).*"
		);
		const cIds = [];
		const pIds = [];
		const vIds = hrefs
			.map((href) => {
				let vId = re.exec(href);
				if (href.includes("shorts")) {
					vId = href.split("/");
					vId.shift();
				} else if (href.includes("/playlist")) {
					let pId = href.split("=");
					pId.shift();
					pId = pId[pId.length - 1];
					pIds.push(pId);
				} else if (
					href.includes("/c") ||
					href.includes("/@") ||
					href.includes("/channel") ||
					href.includes("/user")
				) {
					let cId = href.split("/");
					cId.shift();
					cId = cId[cId.length - 1];
					if (cId.startsWith("@")) {
						cId = cId.replace("@", "");
					}
					cIds.push(cId);
				}
				if (vId?.length > 0) {
					return vId[1];
				}
				return "";
			})
			.filter((el) => el != "");

		if (vIds.length > 0) {
			apiQueue.enqueue(async () => {
				try {
					let ids = "";
					for (let index = 0; index < vIds.length; index++) {
						const element = vIds[index];
						ids = ids + element + ":";
						if (chrefs[index]) {
							ids = ids + chrefs[index];
						}
						if (index != vIds.length - 1) {
							ids = ids + "&ids[]=";
						}
					}
					let url =
						`https://api.kahf.ai/api/v1/videos?ids[]=` +
						ids +
						`&premissible-for=${gender}&practicing-level=${mode}&_country=${yt.config_.GL}`;
					if (gender == 4) {
						let cursor = metaData?.next_cursor ?? "";
						url = `https://api.kahf.ai/api/v1/videos/recommends?permissible-for=${gender}&limit=${vIds.length}&cursor=${cursor}&_country=${yt.config_.GL}`;
					}
					const res = await fetch(url, {
						headers: {
							"Content-Type": "application/json",
							Accept: "application/json",
							Authorization: `Bearer ${token}`,
						},
					});
					const response = await res.json();
					let recommendVideoLength = response?.recommend?.length;
					if (gender == 4) {
						metaData = response?.meta;
					}
					let recommendIndex = 0;
					let relatedVideoLength = response?.related?.length;
					let relatedIndex = 0;
					if (gender == 4) {
						const apis = response?.data?.map((e) =>
							/* window.flutter_inappwebview.callHandler(
							   "fetchYtInitialData",
							   e.id
							 )*/
							KahfTubeInterface.fetchYtInitialData(e.id)
						);
						const datas = await Promise.all(apis);
						for (let index = 0; index < hrefs.length; index++) {
							apiResponses[hrefs[index]] = {
								...response?.data[index],
								type: "recommended",
								metaData: datas[index],
							};
						}
					} else {
						for (const href of hrefs) {
							const fIndex = response?.data?.findIndex((el) =>
								href.includes(el.id)
							);
							if (fIndex !== undefined && fIndex != -1) {
								if (!response?.data[fIndex]?.is_halal) {
									if (
										relatedVideoLength > 0 &&
										relatedIndex < relatedVideoLength
									) {
										/*const res = await window.flutter_inappwebview.callHandler(
										  "fetchYtInitialData",
										  response?.related[relatedIndex].id
										);*/
										const res = await KahfTubeInterface.fetchYtInitialData(response?.related[relatedIndex].id);
										apiResponses[href] = {
											...response?.related[relatedIndex],
											type: "related",
											metaData: res,
										};
										// console.log(JSON.stringify(apiResponses[href]));

										relatedIndex = relatedIndex + 1;
									} else {
										apiResponses[href] = response?.data[fIndex];
									}
								} else {
									apiResponses[href] = response?.data[fIndex];
								}
							} else {
								const cIndex = cIds.findIndex((el) => href.includes(el));
								if (cIndex !== undefined && cIndex != -1) {} else {
									// console.log(href + "----" + 404);

									if (
										recommendVideoLength > 0 &&
										recommendIndex < recommendVideoLength
									) {
										/*const res = await window.flutter_inappwebview.callHandler(
										  "fetchYtInitialData",
										  response?.recommend[recommendIndex].id
										);*/
										const res = await KahfTubeInterface.fetchYtInitialData(response?.recommend[recommendIndex].id);
										apiResponses[href] = {
											...response?.recommend[recommendIndex],
											type: "recommended",
											metaData: res,
										};
										recommendIndex = recommendIndex + 1;
									} else {
										apiResponses[href] = 404;
									}
								}
							}
						}
					}
					callback();
				} catch (error) {
					console.log(error);
				}
			});
		}

		if (cIds.length > 0) {
			// console.log(cIds);
			apiQueue.enqueue(async () => {
				try {
					const res = await fetch(
						`https://api.kahf.ai/api/v1/channels?ids[]=` + cIds.join("&ids[]="), {
							headers: {
								"Content-Type": "application/json",
								Accept: "application/json",
								Authorization: `Bearer ${token}`,
							},
						}
					);
					const response = await res.json();
					// console.log(JSON.stringify(response));
					hrefs.forEach((href) => {
						// console.log(href);
						const fIndex = response?.data?.findIndex(
							(el) =>
							href.toLowerCase().includes(el.id) ||
							href.toLowerCase().includes(el["custom_url"].toLowerCase()) ||
							href.toLowerCase().includes(el["title"].toLowerCase())
						);
						if (fIndex !== undefined && fIndex != -1) {
							apiResponses[href] = response?.data[fIndex];
						}
					});

					hrefs.forEach((href) => {
						const fIndex = cIds.findIndex((el) => href.includes(el));
						if (
							fIndex !== undefined &&
							fIndex != -1 &&
							apiResponses[href] == "loading"
						) {
							// console.log("LOL");
							apiResponses[href] = 404;
						}
					});

					callback();
				} catch (error) {
					console.log(error);
				}
			});
		}
	}
}

let isShareClicked = false;

new MutationObserver(() => {
	const homeIcon = document.querySelector("#home-icon");
	const svg = homeIcon.querySelector("svg")?.children?.item(0);
	if (svg?.getAttribute("fill") == "#ff0000" || "undefined") {
		svg?.setAttribute("fill", "#34A853");
	}

	if (
		document.querySelector("div.mobile-topbar-header-content").children.item(0)
		.textContent == "Open App"
	) {
		document
			.querySelector("div.mobile-topbar-header-content")
			.children.item(0)
			.remove();
	}
	const tab = document.getElementsByTagName("ytm-pivot-bar-item-renderer");
	for (let index = 0; index < tab.length; index++) {
		const element = tab[index];
		if (
			element?.innerText.includes("Shorts") ||
			element?.innerText.includes("Explore")
		) {
			element?.remove();

			let div1 = document.createElement("div");

			div1.setAttribute("role", "tab"),
				div1.setAttribute("aria-selected", false),
				(div1.classList = ["pivot-bar-item-tab pivot-library"]);
			div1.style.paddingTop = "0.53rem";
			div1.style.paddingBottom = "0.53rem";

			let img = document.createElement("img");
			img.setAttribute(
				"src",
				kahfTubeImageUrl
			);
			div1.append(img);

			let div2 = document.createElement("div");
			div2.classList = ["pivot-bar-item-title"];
			div2.innerHTML = "Halalz";
			div1.append(div2);
			div1.onclick = () => {
				//window.flutter_inappwebview.callHandler("onHalalzTap");
				console.log("onHalalzTap")
				KahfTubeInterface.onHalalzTap();
			};
			const tabContainer = document.querySelector("ytm-pivot-bar-renderer");
			tabContainer.append(div1);
		}
	}

	const channelTabs = document.querySelectorAll("a.scbrr-tab");
	for (let index = 0; index < channelTabs.length; index++) {
		const element = channelTabs[index];
		if (element.textContent == "Shorts") {
			element?.remove();
		}
	}

	const tabs = document.querySelectorAll("yt-tab-shape");
	for (let index = 0; index < tabs.length; index++) {
		const element = tabs[index];
		if (element.textContent == "Shorts") {
			element?.remove();
		}
	}

	const shareButton = document.querySelectorAll(
		"button.yt-spec-button-shape-next--tonal.yt-spec-button-shape-next--icon-leading"
	)[1];

	if (shareButton.isConnected && !isShareClicked) {
		isShareClicked = true;
		shareButton.addEventListener("click", async () => {
			/*let shared = await window.flutter_inappwebview.callHandler(
			  "share",
			  location.href
			);*/
			let shared = await KahfTubeInterface.share(location.href);

			if (shared) {
				document.querySelector("c3-overlay").click();
			}
		});
	} else {
		isShareClicked = false;
	}
}).observe(document, {
	subtree: true,
	childList: true
});